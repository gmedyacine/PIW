db.endpointVersions.find(
    { "endpointId": ObjectId("683460c416d9892982ddbeee") },
    { 
        "versionNumber": 1, 
        "status": 1,
        "image": 1,          // Selon la version de Domino, le champ peut s'appeler 'image'
        "imageUri": 1,       // ou 'imageUri'
        "build.image": 1,    // ou être imbriqué dans l'objet de build
        "buildId": 1
    }
).sort({ "versionNumber": -1 })

rs.secondaryOk();
var collections = db.getCollectionNames();
var targetId = ObjectId("69683ec4b54e8f20b3f15d63");
var foundInCollection = "Non trouvé";

for(var i = 0; i < collections.length; i++) {
    var collName = collections[i];
    // On cherche un document avec cet ID dans chaque collection
    var doc = db.getCollection(collName).findOne({ "_id": targetId });
    if (doc) {
        foundInCollection = collName;
        break; // On a trouvé, on arrête de chercher
    }
}

foundInCollection;


rs.secondaryOk()
db.<LE_NOM_TROUVÉ>.find(
    { "modelId": ObjectId("683460c416d9892982ddbeee") }, // Attention, ici "endpointId" est sûrement devenu "modelId"
    { 
        "versionNumber": 1, 
        "image": 1,
        "imageUri": 1
    }
).sort({ "versionNumber": -1 })




rs.secondaryOk()
db.model_versions.find(
    { "modelId.value": ObjectId("683460c416d9892982ddbeee") },
    { 
        "metadata.number": 1,
        "metadata.builds.slug.image": 1
    }
).sort({ "metadata.number": -1 })







rs.secondaryOk();

// 1. Définissez votre liste de paramètres ici
var paramsList = [
    { id: "683460c416d9892982ddbeee", number: 25 },
    // Vous pouvez ajouter d'autres modèles ici :
    // { id: "AUTRE_MODEL_ID", number: 10 }
];

// 2. On boucle sur chaque élément de la liste
paramsList.forEach(function(param) {
    
    // 3. Requête MongoDB avec la condition $lte (inférieur ou égal)
    db.model_versions.find({
        "modelId.value": ObjectId(param.id),
        "metadata.number": { $lte: param.number }
    }).forEach(function(myDoc) {
        
        // 4. Sécurité : vérifier que l'image existe bien pour cette version
        var imageToDelete = "Aucune_image_trouvee";
        if (myDoc.metadata && myDoc.metadata.builds && myDoc.metadata.builds.length > 0) {
            imageToDelete = myDoc.metadata.builds[0].slug.image.repository + ":" + myDoc.metadata.builds[0].slug.image.tag;
        }

        // 5. Affichage avec le format demandé
        print("model_id: " + myDoc.modelId.value + 
              ", number: " + myDoc.metadata.number + 
              ", modevl_versions_id: " + myDoc._id + 
              ", image-to-delete: " + imageToDelete);
    });
});


rs.secondaryOk();

// 1. La nouvelle liste prend maintenant le NOM ('name') au lieu de l'ID
var paramsList = [
    { name: "PROD_FR-ICARE_CLAIMS_AUTOMATION", number: 25 },
    // Ajoutez d'autres modèles ici :
    // { name: "AUTRE_NOM_DE_MODEL", number: 10 }
];

paramsList.forEach(function(param) {
    
    // 2. Étape supplémentaire : On cherche le modèle par son nom pour obtenir son ID
    var modelDoc = db.models.findOne({ "name": param.name });
    
    if (!modelDoc) {
        print("⚠️ Attention : Le modèle '" + param.name + "' est introuvable dans la base.");
        return; // Passe au modèle suivant dans la liste
    }
    
    var targetModelId = modelDoc._id; // On a récupéré l'ObjectId !

    // 3. On reprend votre logique d'origine sur model_versions
    db.model_versions.find({
        "modelId.value": targetModelId, // On utilise l'ID trouvé juste au-dessus
        "metadata.number": { $lte: param.number }
    }).forEach(function(myDoc) {
        
        // 4. Sécurité : vérifier que l'image existe bien pour cette version
        var imageToDelete = "Aucune_image_trouvee";
        if (myDoc.metadata && myDoc.metadata.builds && myDoc.metadata.builds.length > 0) {
            imageToDelete = myDoc.metadata.builds[0].slug.image.repository + ":" + myDoc.metadata.builds[0].slug.image.tag;
        }

        // 5. Affichage final (j'ai rajouté le nom du modèle pour que vos logs soient plus clairs)
        print("model_name: " + param.name + 
              ", model_id: " + myDoc.modelId.value + 
              ", number: " + myDoc.metadata.number + 
              ", modevl_versions_id: " + myDoc._id + 
              ", image-to-delete: " + imageToDelete);
    });
});

